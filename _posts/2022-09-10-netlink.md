---
layout: post  
title: 搞定锐捷认证，享受智能生活
categories: 笔记
tags: 锐捷 米家
author: Ko_teiru
---

* content
{:toc}

> 上个月月底开学，搬入新校区，得知大二时使用的家庭宽带业务已经不提供服务了，取而代之的是统一的校园网服务。  
> 没办法，用不了总不能不用吧，加点钱继续整了个半年的校园网套餐，毕竟不知道什么时候就会走。办理时悄悄询问了一下营业厅的工作人员，问这次使用的校园网供应商。  
> 结果被说是华为的，我还寻思华为啥时候开始搞校园网业务了。回去一看和大一那会一样，依旧使用的是锐捷的校园网认证方案，只不过改成了电脑端手机端统一使用的网页认证罢了（认证网页连学校 logo 还没加上，笑死我了）。





### 准备
要搞定锐捷认证，必须请出我们的老朋友———MentoHUST 了。  
不过和大一那会还是用别人刷好的带 MentoHUST 的硬路由来上网的，稳定性实在不敢恭维。大二之后开始捣鼓软路由的我必定选择扩展性更好的软路由来实现这个操作了。  
这次使用的软路由是咸鱼收的二手 R4S，虽然是二手但是还是好贵，真的是理财产品了。不过校园网那小水管，即使是 R2S 的性能也绰绰有余了。买这个属于是从长远的角度考虑了。  
固件依旧是使用的自己编译的 [lean 的 OpenWrt 固件](https://github.com/coolsnowwolf/openwrt)，而 MentoHUST 也使用的是支持 OpenWrt 的包（[这里](https://github.com/KyleRicardo/MentoHUST-OpenWrt-ipk)）。  
虽然这个软件没有 luci 界面，不过用 ssh 的方式进行操作也是没有任何问题的。（指写个 sh 脚本加入启动项，开机自己启动。断线重播之类的功能软件本身就自带了）

#### R2S、R4S编译需要注意的事项
编译的时候，`Target System` 直接选择 `Rockchip`，`Subtarget` 选择 `RK33xx/RK35xx boards（64 bit）`。

`Target profile` 请根据软路由型号选择，例如 R4S 就选择 `FriendlyARM NanoPi R4S`（重点在后面的**NanoPi R?S**)

编译输出选项中请取消 `ext4` 的勾选，选择此项可能导致编译失败。另外本人依旧比较推荐勾选 `tar.gz`，编译完成后将压缩包复制到电脑上再解压写入，可以有效保证固件完整性。（要说的话就是直接编译出来的 `img` 文件次次写入都有一部分报错，虽然好像不影响使用不够看着不舒服）  

### 执行

首先把宿舍室内交换机的线接入软路由的 wan 口（交换机在室内的弱电箱内），OpenWRT内 lan 口的通讯方式不用改，使用默认的 DHCP 就行。连接上了之后先修改一下 `/etc/mentohust.conf`。把除了用户名和密码的其余配置项配置好。  
当然，有些用不到的配置项也不用非得填，比如固定 IP 那玩意就是不用就不用填。
> 这里不填用户名密码是因为这里的密码可能是加密后了的，明文写入会直接报密码错误，然后我这校园网的反馈信息又是 GBK 编码的。。  
> 导致我在 ssh 里看见的都是一堆乱码，把 log 拷贝下来才发现问题所在。后面尝试使用指令带入的密码成功认证。  
> 至于认证方式应该先试试锐捷，DHCP的话一个个试吧，连不上 `mentohust -k` 就完事了

配置好之后用指令测试一下是否能够成功认证，并且观察报错信息进行排错。*如果发现输出消息乱码，请把消息输出方式改为输出至文件，并把日志文件下载到电脑上进行查看*  
`mentohust -u校园网账户 -p校园网密码`  
不出意外的话就不出意外认证成功了，软路由的 lan 口连接的设备（你的电脑）应该能免认证上网了。  
像R2S、R4S之类的双网口设备建议 lan 口接个硬路由，然后把路由设置问有线桥接模式，这下所有的数据啥的全权交给软路由处理，硬路由单纯承担交换无线数据用。  
至于其他的东西就懒得说了，比如 DNS加速 和一堆奇奇怪怪的东西啥的啊，能上网就行了。


### 总结
R4S 花了 400+，硬路由是小米的 AX3000 移动定制版花了100+，校园网花了200-。虽然看着花了挺多钱，不过要是按学校一人一网来算的话还是给舍友们省了不少钱的。虽然根本也没叫他们交钱就是了，本来呆这的时间也没多久，好好珍惜大学生活吧，笑死。  
主要的话是宿舍有网了我的米家设备才能用，本质还是为了自己舒服方便罢了。谁不想下课前20分钟就把寝室空调打开呢？  
另外虽然这篇小作文就30来行，不过当时捣鼓可废了我不少劲，没办法，老年痴呆了，这些东西不记录一下以后真想不起来了。  
另外之前挖的编译 OpenWrt 的坑也没填完，倒是没想到这个先写出来了，继续笑死

### 猫鼠游戏
> 以下内容为 9月22日晚 更新

学校自从新生开学之后就开始 ban 我校园网账号了，每次被 ban 都是封我几分钟，然后就可以正常登陆使用了。虽然伤害不大，但是有够嘲讽的。遂在网上寻求解决方案，参考了 [SunBK201](https://www.sunbk201.site) 大佬写的[这篇文章](https://www.sunbk201.site/posts/crack-campus-network.html)，开始着手对校园网检测进行反制措施。  
TLL 检测，时钟偏移这两个好解决，跟着文章复制几条防火墙规则应用一下就行了，难缠的是这个 UA 检测机制。  
一开始并不打算重新编译固件，因为那台 Ubuntu 虚拟机编译了几次固件之后快把我硬盘吃光了，就想着先用他写的另一种方法试试，那就是用 OpenClash 对80端口的流量加密。  
方法很简单，但是新版的 OpenClash 的实现步骤又和[大佬写的文章](https://www.sunbk201.site/posts/change-ua-by-proxy.html)有些许不同。首先你得去 `配置文件管理` 里点击 `规则集文件列表` 的按钮，拉到最下面你应该能看见 `新建文件` 的按钮，点击输入文件名，只要能够区分就行，这里我就管它叫 `80killer`。点击完成之后再拉到最上面，因为它这里是按字母顺序排序的，数字应该在所有字母上方，如果你叫其他的名字，那你自己找找就行。  
找到刚才创建的配置文件，点击修改，即可进入配置文件编辑界面。填入下面的内容即可点击 `保存配置` 按钮退出。  
>（# 井号后面的为备注，自己看心情改）  
```
payload:  
  # > 80 killer 
  - DST-PORT,80
```
保存完成后转到 `规则集与策略组管理`，点击 `自定义规则集与策略组管理（仅 TUN & Meta 内核）` 下的 `添加` 按钮。不出意外会跳转到一个新的界面，有许多可以选择的项目，`配置文件` 请选择当前使用的配置文件，避免不同配置文件所使用的策略名不同。这里我们需要把 `规则集类型` 改为 `file`，`规则集路径` 就选你刚出创建的规则名即可。`规则集匹配顺序` 确保是 `优先(覆盖)`，`指定策略组` 根据对应的配置文件的来选，一般直接选 `Proxy` 就行。（我不推荐把80端口直接阻断，因为这会让很多东西无法使用，说实话即使是选择 Proxy 也会导致我的小爱同学间接抽风、淘宝位置跑到国外）  
以上，你的 OpenClash 应该可以把 80 端口的流量加密处理了，这很大程度可以缓解校园网 ban 你的时间，但是它带来的 debuff 和不稳定性让我接受不了。（没开加密一天能被踢掉好几次，开了一天踢一次左右）再加上 http 的流量不止 80 端口能跑，8080 端口有时候也会跑，但是用这规则就匹配不到了，所以治标不治本。  
综上所述，我还是更推荐大家使用 UA2F，即使他需要对路由器固件进行手动编译，但是如果你使用的是 R2s 或者 R4s 以及 X86 设备的话，我能为你提供包含了 MentoHUST 和 UA2F 的固件，刷入即可使用。  
至于编译的方法和过程，我估计以后才会再写，毕竟算是比较麻烦的了。有信心的可以直接看大佬的[原文](https://sunbk201public.notion.site/sunbk201public/OpenWrt-f59ae1a76741486092c27bc24dbadc59)。  

---
最后愿大伙都能自由支配自己所购买的校园网，一人一号我能理解，一人一设备纯纯脑残。